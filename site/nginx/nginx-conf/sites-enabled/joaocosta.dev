server {
  listen 443 ssl http2 default_server;
  listen [::]:443 ssl http2 default_server;
  # serve onion service
  listen unix:/socket/tor-joaocosta.dev.sock;

  server_name joaocosta.dev www.joaocosta.dev erycap2gpjs7vi5ax2nw3yo5oo4567vi3ompttcqlklcx3ownrfey6ad.onion localhost www.localhost;

  root /app/main;
  index index.php;

  error_page 403 =301 /404;
  error_page 404 =301 /404;

  # secure stuff
  location ~ /(App/|cache/|(data/)?database/|js_src/|node_modules/|vendor/|composer.*|package.*json|rollup.config.js|tailwind.config.js|tsconfig.json) {
    return 404;
  }

  # adapted from: https://www.nginx.com/resources/wiki/start/topics/recipes/symfony/
  location / {
    try_files $uri /index.php$is_args$args;
  }

  location = /favicon.ico { access_log off; log_not_found off; }
  location = /robots.txt  { access_log off; log_not_found off; }

  location ~ ^/index\.php(/|$) { 
    # Prevents URIs that include the front controller. This will 404:
    # http://domain.tld/index.php/some-path
    # Remove the internal directive to allow URIs like this
    internal;

    fastcgi_pass php:9000;
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    include fastcgi_params;
    include fastcgi.conf;
  }

  # return 404 for all other php files not matching the front controller
  # this prevents access to other php files you don't want to be accessible.
  location ~ \.php$ { return 404; }
}

server {
  # redirect all http to https
  listen 80 default_server;
  listen [::]:80 default_server;

  server_name joaocosta.dev www.joaocosta.dev localhost www.localhost;

  return 301 https://$host$request_uri;
}
