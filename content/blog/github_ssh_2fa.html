<!DOCTYPE html>
<html lang="en">
  <head>
    <title>JoaoCostaIFG - a simple blog</title>
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" type="image/png" href="/favicon.png" />
    <meta charset="utf-8" />
    <!--PageInfo
    title: "Github, ssh keys and 2FA"
    date: 2020-03-09
    description: "I recently found myself setting up 2FA on my GitHub account and for that I started using the <b>ssh protocol</b> instead of the default <b>https protocol</b>. This is a quick guide explaining how and why you'd want to do that too."
    -->
  </head>

  <body>
    <h1>
      <a href="/">JoaoCostaIFG (https://joaocosta.dev)</a>
    </h1>

    <div class="links">
      <div class="cat">
        <a href="/cat/about.html">About me</a>
      </div>
      <div class="cat">
        <a href="/cat/contacts.html">Contacts</a>
      </div>
      <div class="cat">
        <a href="/cat/projects.html">Projects</a>
      </div>
      <div class="cat">
        <a href="https://github.com/JoaoCostaIFG">Github</a>
      </div>
    </div>

    <h2>Github, ssh keys and 2FA</h2>

    <h3>Introduction</h3>

    <p>
      I have a little project going on where I use a
      <a href="https://www.raspberrypi.org/blog/raspberry-pi-zero/"
        >raspberry pi zero</a
      >
      as a dedicated password manager. It could more accurately be described as
      a secrets keeper/manager, but I use it mostly for passwords.<br />
      Anyway, I wanted to set up 2FA for as many services as I could (I'm
      currently using
      <a href="https://f-droid.org/en/packages/org.liberty.android.freeotpplus/"
        >FreeOTP+</a
      >
      on android and it has everything I need/want), so I started setting them
      up. Both my raspberry pi and my android have the OTPs for redundancy.
    </p>

    <p>
      At some point, I set up
      <a
        href="https://help.github.com/en/github/authenticating-to-github/securing-your-account-with-two-factor-authentication-2fa"
        >2FA on my Github account</a
      >
      and all seemed well, until I tried pushing to one of my GitHub
      repositories from the command line.
    </p>

    <h3>2FA and the command line</h3>

    <p>
      It seems like 2FA and git from the command line don't play well together.
      For example, if you try to clone a private repository, your credentials
      will not be accepted. You'll get an "invalid username or password" error
      message. This happens because GitHub uses the <b>https protocol</b> by
      default and recommends it for its users, because it usually works
      <i>out of the box</i>.
    </p>

    <p>
      If you want to use 2FA (you should) with git on the command line, you'll
      have to use one of these solutions.
    </p>

    <h4>Solution 1: Create a personal access token</h4>

    <p>
      You should do this if you intend to keep using the
      <b>https protocol</b> for your GitHub operations. GitHub has a nice
      step-by-step
      <a
        href="https://help.github.com/en/github/authenticating-to-github/creating-a-personal-access-token-for-the-command-line"
        >guide</a
      >
      on their help page explaining how to do this, but the tl;dr is:
    </p>
    <ul>
      <li>Go to your account settings;</li>
      <li>Go to the <b>Developer settings</b> tab;</li>
      <li>Go to the <b>Personal access tokens</b> tab;</li>
      <li>Press the <b>Generate new token</b> button;</li>
      <li>Give it a name and the permissions you want/need (e.g.: repo);</li>
      <li>
        Copy the token and keep it safe like you would for your password (the
        token isn't recoverable).
      </li>
    </ul>
    <p>
      Now to use the token, you just need to provide it during the
      authentication process instead of your password.
    </p>

    <p>
      I don't like this solution because you have to keep track of 2 different
      passwords (more vulnerable) and this new <i>"token password"</i> defeats
      the purpose of 2FA (since it bypasses the 2FA temporary code). You can
      mitigate these problems by limiting how much <i>power</i> the access token
      has (give it fewer permissions), but it still isn't optimal.
    </p>

    <h4>Solution 2: Use the <b>ssh protocol</b></h4>

    <p>
      To use the <b>ssh protocol</b>, you'll need an <b>ssh key pair</b>. While
      browsing the web, I came across this amazing
      <a href="https://happygitwithr.com/ssh-keys.html">tutorial</a>, which
      helped me understand the subject better and quickly set everything up
      correctly.
    </p>

    <p>
      I advise you to read it, but if you're in a worry and on Linux, you can
      just copy the commands below (which were taken from the tutorial linked
      above) and follow the on-screen instructions:
    </p>

    <pre><code class="language-bash">
# this will ask for a filename and an optional passphrase for the key (you should
# provide it one)
ssh-keygen -t rsa -b 4096 -C "USEFUL-COMMENT"

# this makes sure the ssh-agent is running
eval "$(ssh-agent -s)"
# add your key to the ssh-agent (change the path to the key if you didn't use
# the default)
ssh-add ~/.ssh/id_rsa
    </code></pre>

    <p>
      After generating your key, you just need to associate the generated public
      key with your GitHub account. To do this, you need to go to your GitHub
      account settings, access the <b>SSH and GPG keys</b> tab, and copy the
      contents of your public key to a new <b>ssh key</b>, e.g. using:
      <code>xclip -sel clip &lt; ~/.ssh/id_rsa.pub</code> to insert the key
      contents into your clipboard.
    </p>

    <p>
      Now that you have associated your <b>ssh key</b> with your account, you
      just need to start using the <b>ssh protocol</b> versions of your remote
      links.
    </p>

    <p>
      Imagine you have the following repository:
      <code>https://github.com/leereilly/games.git</code>. It is using the
      <b>https protocol</b>. The equivalent <b>ssh protocol</b> link is:
      <code>git@github.com:leereilly/games.git</code>. As you can see, it is
      really easy to convert from one <b>protocol</b> to another. I even found a
      <a href="https://gist.github.com/m14t/3056747">small bash script</a> to
      make the conversion of your repository's remotes to the
      <b>ssh protocol</b>.
    </p>

    <pre><code class="language-bash">
#/bin/bash
#-- Script to automate https://help.github.com/articles/why-is-git-always-asking-for-my-password

REPO_URL="$(git remote -v | grep -m1 '^origin' | sed -Ene's#.*(https://[^[:space:]]*).*#\1#p')"
if [ -z "$REPO_URL" ]; then
  echo "-- ERROR:  Could not identify Repo url."
  echo "   It is possible this repo is already using SSH instead of HTTPS."
  exit
fi

USER="$(echo $REPO_URL | sed -Ene's#https://github.com/([^/]*)/(.*).git#\1#p')"
if [ -z "$USER" ]; then
  echo "-- ERROR:  Could not identify User."
  exit
fi

REPO="$(echo $REPO_URL | sed -Ene's#https://github.com/([^/]*)/(.*).git#\2#p')"
if [ -z "$REPO" ]; then
  echo "-- ERROR:  Could not identify Repo."
  exit
fi

NEW_URL="git@github.com:$USER/$REPO.git"
echo "Changing repo url from "
echo "  '$REPO_URL'"
echo "      to "
echo "  '$NEW_URL'"
echo ""

git remote set-url origin "$NEW_URL"

echo "Success"
    </code></pre>

    <p>
      This is the solution that I went with. I believe the only problem you can
      have while using the <b>ssh protocol</b> is having the connection to port
      22 (ssh port) blocked is in your network. I've never had that problem, but
      GitHub suggests that you may still be able to
      <a
        href="https://help.github.com/en/github/authenticating-to-github/using-ssh-over-the-https-port"
        >use <b>ssh</b> over the <b>https</b> port</a
      >
      if you ever find yourself in such a situation.
    </p>

    <h3>Conclusions</h3>

    <p>
      This was mostly a quick PSA to get more people to use the
      <b>ssh protocol</b> and 2FA on github. It's easy and it'll keep your
      accounts more secure. Stay safe :P
    </p>
  </body>
</html>
